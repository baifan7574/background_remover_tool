# ⚠️ 重要 - 服务器配置说明

**创建日期**: 2025-12-29  
**最后更新**: 2025-12-29  
**重要性**: 🔴 极高 - 修改前必读

---

## 🚨 关键警告

**在修改任何服务器配置前,必须先阅读本文档!**

本服务器上运行着**两个独立的网站**,它们使用**不同的端口**。混淆端口配置会导致网站无法访问!

---

## 📋 服务器架构

### 服务器信息
- **IP地址**: 43.130.229.184 (腾讯云)
- **SSH用户**: root / lighthouse
- **Web服务器**: Nginx (反向代理)

### 网站配置

#### 1️⃣ NBFive (nbfive.com)
```
域名: nbfive.com, www.nbfive.com
端口: 5000
进程: Flask (python3 sk_app.py)
目录: /home/lighthouse/background_remover_tool/
Nginx配置: /etc/nginx/sites-available/nbfive
启动方式: nohup python3 sk_app.py > sk_app.log 2>&1 &
```

**特征**:
- 标题: "NBFive AI" / "PixelMagic"
- 主题: 跨境电商处理专家
- 功能: 背景移除、图片压缩等工具

#### 2️⃣ SoEasyHub (soeasyhub.com)
```
域名: soeasyhub.com (或其他域名)
端口: 9999
进程: Gunicorn (python3 -m gunicorn -w 4 -b 127.0.0.1:9999 app:app)
目录: /home/lighthouse/soeasyhub/ (推测)
Nginx配置: /etc/nginx/sites-available/soeasyhub
启动方式: Gunicorn多进程模式
```

**特征**:
- 标题: "SoEasyHub"
- 主题: 专业在线工具
- 功能: 各类在线工具集合

---

## ⛔ 常见错误 (必须避免!)

### ❌ 错误1: 混淆端口
**错误示例**:
```nginx
# 错误! NBFive应该用5000,不是9999
location / {
    proxy_pass http://127.0.0.1:9999;  # ❌ 错误!
}
```

**正确配置**:
```nginx
# NBFive配置
location / {
    proxy_pass http://127.0.0.1:5000;  # ✅ 正确!
}
```

### ❌ 错误2: 修改错误的配置文件
- 修改NBFive时,只能改 `/etc/nginx/sites-available/nbfive`
- 修改SoEasyHub时,只能改 `/etc/nginx/sites-available/soeasyhub`
- **绝对不要**把两个网站的配置混在一起!

### ❌ 错误3: PowerShell变量未转义
**错误示例**:
```nginx
proxy_set_header Host $host;  # 在PowerShell中会被解析成变量!
```

**解决方案**:
- 使用本地文件 + SCP上传
- 或使用单引号/heredoc避免变量替换

---

## ✅ 正确的修改流程

### 修改Nginx配置的标准步骤:

1. **确认要修改哪个网站**
   ```bash
   # 列出所有网站配置
   ssh root@43.130.229.184 "ls -la /etc/nginx/sites-enabled/"
   ```

2. **备份现有配置**
   ```bash
   ssh root@43.130.229.184 "cp /etc/nginx/sites-available/nbfive /etc/nginx/sites-available/nbfive.backup"
   ```

3. **在本地创建新配置文件**
   ```bash
   # 在本地编辑,避免转义问题
   notepad d:\quicktoolshub\雷达监控。\nbfive_nginx.conf
   ```

4. **上传到服务器**
   ```bash
   scp nbfive_nginx.conf root@43.130.229.184:/etc/nginx/sites-available/nbfive
   ```

5. **测试配置**
   ```bash
   ssh root@43.130.229.184 "nginx -t"
   ```

6. **重载Nginx**
   ```bash
   ssh root@43.130.229.184 "systemctl reload nginx"
   ```

7. **验证网站**
   - 访问 https://nbfive.com
   - 检查是否显示正确的网站内容

---

## 🔍 故障排查

### 问题: 网站显示502错误

**检查步骤**:

1. **检查进程是否运行**
   ```bash
   ssh root@43.130.229.184 "ps aux | grep -E 'python|gunicorn'"
   ```
   
   应该看到:
   - NBFive: `python3 sk_app.py` (端口5000)
   - SoEasyHub: `gunicorn ... :9999` (端口9999)

2. **检查端口监听**
   ```bash
   ssh root@43.130.229.184 "netstat -tlnp | grep ':5000\|:9999'"
   ```
   
   应该看到:
   ```
   tcp  0.0.0.0:5000  LISTEN  python3
   tcp  127.0.0.1:9999  LISTEN  python3
   ```

3. **检查Nginx配置**
   ```bash
   ssh root@43.130.229.184 "cat /etc/nginx/sites-available/nbfive"
   ```
   
   确认 `proxy_pass` 指向正确端口!

4. **查看日志**
   ```bash
   # NBFive日志
   ssh root@43.130.229.184 "tail -50 /home/lighthouse/background_remover_tool/sk_app.log"
   
   # Nginx错误日志
   ssh root@43.130.229.184 "tail -50 /var/log/nginx/error.log"
   ```

### 问题: 访问NBFive却显示SoEasyHub

**原因**: Nginx配置错误,端口指向了9999

**解决**:
1. 检查 `/etc/nginx/sites-available/nbfive`
2. 确认 `proxy_pass http://127.0.0.1:5000`
3. 重启NBFive的Flask进程

---

## 📝 快速参考

### 重启NBFive
```bash
# 1. 停止旧进程
ssh root@43.130.229.184 "pkill -f sk_app.py"

# 2. 启动新进程
ssh root@43.130.229.184 "cd /home/lighthouse/background_remover_tool && nohup python3 sk_app.py > sk_app.log 2>&1 &"

# 3. 验证
ssh root@43.130.229.184 "ps aux | grep sk_app.py"
```

### 重启SoEasyHub
```bash
# 通常不需要重启,Gunicorn会自动重载
# 如果必须重启:
ssh root@43.130.229.184 "systemctl restart gunicorn"  # (如果配置了systemd)
```

### 重载Nginx
```bash
ssh root@43.130.229.184 "nginx -t && systemctl reload nginx"
```

---

## 🎯 部署检查清单

每次部署后,必须验证:

- [ ] NBFive (https://nbfive.com) 显示 "NBFive AI" / "PixelMagic"
- [ ] SoEasyHub 显示 "SoEasyHub" (如果有域名)
- [ ] 两个网站都能正常访问,没有502错误
- [ ] 进程监听正确的端口 (5000 和 9999)
- [ ] Nginx配置测试通过 (`nginx -t`)

---

## 📞 紧急联系

如果出现严重问题:

1. **立即回滚**: 使用备份的配置文件
2. **重启所有服务**: Nginx + Python进程
3. **检查日志**: 查看错误信息
4. **联系管理员**: 提供详细的错误日志

---

## 📚 相关文档

- Nginx官方文档: https://nginx.org/en/docs/
- Flask部署指南: https://flask.palletsprojects.com/en/latest/deploying/
- Gunicorn文档: https://docs.gunicorn.org/

---

**最后提醒**: 
- ⚠️ 修改前先备份
- ⚠️ 确认端口配置
- ⚠️ 测试后再重载
- ⚠️ 验证两个网站都正常

**记住**: NBFive=5000, SoEasyHub=9999!
